<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HWCS State Standards Alignment</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      /* Floating FAB */
      #generateJson {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1000;
        border-radius: 50%;
        width: 3.5rem;
        height: 3.5rem;
        padding: 0;
        font-size: 1.25rem;
      }
      /* Pane scrolling */
      #standardsPane,
      #detailPane {
        height: calc(100vh - 4rem);
        overflow-y: auto;
      }
      /* Distinct styling for toolbar labels vs. buttons */
      .navbar .input-group-text {
        background-color: #e2e6ea;
        font-weight: 600;
        border-color: #ced4da;
        margin-right: -1px;
      }
      .navbar .form-control[type="file"] {
        background-color: #fff;
        border-left: none;
      }
      /* Visually indicate disabled inputs */
      .form-control:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background-color: #e9ecef;
      }
    </style>
  </head>
  <body class="bg-light">
    <!-- Top toolbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
      <div class="container-fluid">
        <span class="navbar-brand">HWCS State Standards Alignment</span>
        <div class="d-flex align-items-center">
          <div class="input-group input-group-sm me-2">
            <span class="input-group-text">State</span>
            <input
              type="text"
              id="stateInput"
              class="form-control"
              placeholder="Enter state"
            />
          </div>
          <div class="input-group input-group-sm me-2">
            <span class="input-group-text">Standards CSV</span>
            <input
              type="file"
              id="standardsFile"
              class="form-control"
              accept=".csv"
            />
          </div>
          <div class="input-group input-group-sm me-2">
            <span class="input-group-text">Import JSON</span>
            <input
              type="file"
              id="importJsonFile"
              class="form-control"
              accept=".json"
              title="Import existing alignment JSON"
              disabled
            />
          </div>
        </div>
      </div>
    </nav>

    <!-- Two-pane layout -->
    <div class="container-fluid">
      <div class="row g-0">
        <!-- Left pane: standards list -->
        <div id="standardsPane" class="col-3 bg-white p-3">
          <div class="mb-3">
            <input
              type="search"
              id="searchStandards"
              class="form-control form-control-sm"
              placeholder="Search standards"
            />
          </div>
          <div class="accordion" id="standardsAccordion">
            <!-- Dynamic standard items go here -->
          </div>
        </div>

        <!-- Right pane: projects details -->
        <div id="detailPane" class="col-9 p-3">
          <h3 id="detailHeader">Select a standard</h3>
          <div id="coursesContainer"></div>
        </div>
      </div>
    </div>

    <!-- Floating Generate JSON button -->
    <button
      id="generateJson"
      class="btn btn-primary shadow"
      title="Generate JSON"
    >
      <i class="bi bi-download"></i>
    </button>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- PapaParse CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
      // Auto-load Scope & Sequence CSV from local file
      fetch("Scope_Sequence.csv")
        .then((response) => response.text())
        .then((csvText) => {
          Papa.parse(csvText, {
            header: true,
            skipEmptyLines: true,
            complete(results) {
              projects = results.data.map((row) => ({
                id: row["ID"],
                name: row["Project Name"],
                course: row["Course"],
              }));
              console.log(
                "✅ Projects loaded from Scope_Sequence.csv:",
                projects
              );
              tryRender();
            },
          });
        })
        .catch((err) =>
          console.error("Failed to load Scope_Sequence.csv:", err)
        );
    </script>

    <!-- Application Script: insert your existing JS below -->
    <script>
      let standards = [];
      function updateImportInput() {
        const importInput = document.getElementById("importJsonFile");
        importInput.disabled = !(stateValue && standards.length > 0);
      }
      let projects = [];
      let stateValue = "";
      let importedAlignments = new Map();
      // Track current user selections (seeded from importedAlignments)
      let selectedAlignments = new Map(importedAlignments);
      document.getElementById("stateInput").addEventListener("input", (e) => {
        stateValue = e.target.value.trim();
        updateImportInput();
      });

      const standardsAccordion = document.getElementById("standardsAccordion");
      const detailHeader = document.getElementById("detailHeader");
      const coursesContainer = document.getElementById("coursesContainer");
      const searchStandardsInput = document.getElementById("searchStandards");

      // Parse Standards CSV → standards[]
      document
        .getElementById("standardsFile")
        .addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete(results) {
              standards = results.data.map((row) => ({
                state: stateValue,
                grade: row["Grade"],
                standardId: row["Standard ID"],
                standardText: row["Standard Text"],
              }));
              console.log("✅ Standards loaded:", standards);
              updateImportInput();
              tryRender();
            },
          });
        });

      // Import existing JSON to pre-check boxes
      document
        .getElementById("importJsonFile")
        .addEventListener("change", (e) => {
          const importInput = document.getElementById("importJsonFile");
          if (importInput.disabled) {
            alert(
              "Please enter a state and upload standards before importing JSON."
            );
            importInput.value = "";
            return;
          }
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const arr = JSON.parse(reader.result);
              importedAlignments.clear();
              arr.forEach((entry) => {
                // find matching standard index
                const idx = standards.findIndex(
                  (s) =>
                    s.standardId === entry["Standard ID"] &&
                    s.grade === entry["Grade"] &&
                    s.state === entry["State"]
                );
                if (idx >= 0) {
                  const key = `${idx}::${entry["Course Name"]}`;
                  importedAlignments.set(key, entry["Project Name"] || []);
                }
              });
              // Seed current selections from imported data
              selectedAlignments = new Map();
              importedAlignments.forEach((v, k) => {
                selectedAlignments.set(k, [...v]);
              });
              console.log("✔ Imported alignment JSON:", importedAlignments);
              // re-render to apply imported checks
              renderStandardsAccordion(searchStandardsInput.value.trim());
            } catch (err) {
              console.error("Failed to parse JSON:", err);
            }
          };
          reader.readAsText(file);
        });

      // Phase 2: Grade → Courses mapping
      const gradeToCourses = {};
      function addMapping(grades, course) {
        grades.forEach((g) => {
          if (!gradeToCourses[g]) gradeToCourses[g] = [];
          if (!gradeToCourses[g].includes(course)) {
            gradeToCourses[g].push(course);
          }
        });
      }

      // Define mappings per spec
      addMapping(["K-2", "1", "2"], "CS Adventures with VR");
      addMapping(["3-5", "3", "4", "5", "4-6"], "CS Breakthroughs with VR");
      addMapping(["5-8", "6-8", "6", "7", "8", "MS"], "CS Connections with VR");
      addMapping(["9-12", "9-10", "9", "10", "HS"], "CS Dimensions with VR");
      addMapping(
        [
          "6-10",
          "6-8",
          "9-12",
          "9-10",
          "6",
          "7",
          "8",
          "9",
          "10",
          "MS",
          "HS",
          "10 - Web Design Foundations",
        ],
        "Web Development"
      );
      addMapping(
        ["6-8", "9-10", "9-12", "7", "8", "9", "10", "11", "MS", "HS"],
        "Intro to Python"
      );
      addMapping(
        ["6-8", "9-10", "9-12", "8", "9", "10", "11", "12", "MS", "HS"],
        "Data Science & AI"
      );

      // Utility to retrieve courses for a given grade
      function getCoursesForGrade(grade) {
        return gradeToCourses[grade] || [];
      }

      // Render the standards list in the accordion
      function renderStandardsAccordion(filterText = "") {
        standardsAccordion.innerHTML = ""; // clear previous
        const filteredStandards = standards
          .map((std, index) => ({ ...std, index }))
          .filter((std) => {
            if (!filterText) return true;
            const search = filterText.toLowerCase();
            return (
              (std.standardId &&
                std.standardId.toLowerCase().includes(search)) ||
              (std.standardText &&
                std.standardText.toLowerCase().includes(search)) ||
              (std.grade && std.grade.toLowerCase().includes(search))
            );
          });

        filteredStandards.forEach((std) => {
          const headerId = `heading${std.index}`;
          const collapseId = `collapse${std.index}`;
          // Sanitize heading text
          const headerText = `${std.standardId} - ${std.standardText}`
            .replace(/\u00A0/g, " ")
            .replace(/\s+/g, " ")
            .trim();

          const accordionItem = document.createElement("div");
          accordionItem.className = "accordion-item";

          accordionItem.innerHTML = `
          <h2 class="accordion-header" id="${headerId}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
              ${headerText}
            </button>
          </h2>
          <div id="${collapseId}"
               class="accordion-collapse collapse"
               aria-labelledby="${headerId}"
               data-bs-parent="#standardsAccordion"
               data-std-index="${std.index}">
            <div class="accordion-body">
              Grade: ${std.grade}
            </div>
          </div>
        `;

          standardsAccordion.appendChild(accordionItem);

          // Add event listener for when this accordion item is shown
          const collapseEl = accordionItem.querySelector(`#${collapseId}`);
          collapseEl.addEventListener("shown.bs.collapse", () => {
            // Update detail pane header
            detailHeader.textContent = headerText;
            // Clear previous courses container
            coursesContainer.innerHTML = "";
            // Get courses for this standard's grade
            const coursesFor = getCoursesForGrade(std.grade);
            if (!coursesFor.length) {
              coursesContainer.innerHTML = `<p class="text-muted">No courses found for grade "${std.grade}".</p>`;
              return;
            }

            coursesFor.forEach((courseName) => {
              const courseProjects = projects.filter(
                (p) => p.course === courseName
              );
              if (courseProjects.length) {
                // Create a card for each course
                const card = document.createElement("div");
                card.className = "card mb-3";
                const cardBody = document.createElement("div");
                cardBody.className = "card-body";
                const cardTitle = document.createElement("h5");
                cardTitle.className = "card-title";
                cardTitle.textContent = courseName;
                cardBody.appendChild(cardTitle);

                courseProjects.forEach((proj) => {
                  const labelText = `${proj.id} ${proj.name}`
                    .replace(/\u00A0/g, " ")
                    .replace(/\s+/g, " ")
                    .trim();
                  const cb = document.createElement("input");
                  cb.type = "checkbox";
                  cb.dataset.stdIndex = std.index;
                  cb.dataset.course = courseName;
                  cb.value = labelText;
                  cb.className = "form-check-input me-2";
                  cb.id = `cb-${std.index}-${courseName}-${proj.id}`;
                  // apply existing selection if present
                  const sel =
                    selectedAlignments.get(`${std.index}::${courseName}`) || [];
                  if (sel.includes(cb.value)) cb.checked = true;

                  // Update selectedAlignments when user toggles a checkbox
                  cb.addEventListener("change", () => {
                    const key = `${std.index}::${courseName}`;
                    const arr = selectedAlignments.get(key) || [];
                    if (cb.checked) {
                      if (!arr.includes(cb.value)) arr.push(cb.value);
                    } else {
                      const i = arr.indexOf(cb.value);
                      if (i >= 0) arr.splice(i, 1);
                    }
                    selectedAlignments.set(key, arr);
                  });

                  const label = document.createElement("label");
                  label.className =
                    "form-check-label d-flex align-items-center";
                  label.htmlFor = cb.id;
                  label.appendChild(cb);
                  label.appendChild(document.createTextNode(labelText));

                  const div = document.createElement("div");
                  div.className = "form-check";
                  div.appendChild(label);

                  cardBody.appendChild(div);
                });
                card.appendChild(cardBody);
                coursesContainer.appendChild(card);
              }
            });
          });
        });

        // If any accordion item is expanded, collapse it and reset detail pane
        detailHeader.textContent = "Select a standard";
        coursesContainer.innerHTML = "";
      }

      // Call render once both files have been parsed
      function tryRender() {
        if (standards.length && projects.length) {
          renderStandardsAccordion();
        }
      }

      // Search standards input handler
      searchStandardsInput.addEventListener("input", (e) => {
        const val = e.target.value.trim();
        renderStandardsAccordion(val);
      });

      // File inputs already call tryRender on change, no need to add again

      // Phase 4: Build result from all standard-course combos using selectedAlignments
      document.getElementById("generateJson").addEventListener("click", () => {
        const result = [];
        standards.forEach((std, sIdx) => {
          const coursesFor = getCoursesForGrade(std.grade);
          if (!coursesFor.length) return; // skip grades without courses
          coursesFor.forEach((courseName) => {
            const key = `${sIdx}::${courseName}`;
            const projList = selectedAlignments.get(key) || [];
            result.push({
              State: std.state,
              Grade: std.grade,
              "Standard ID": std.standardId,
              "Standard Text": std.standardText,
              "Course Name": courseName,
              "Project Name": projList,
            });
          });
        });

        const jsonStr = JSON.stringify(result, null, 2);
        // Show JSON in detail pane
        detailHeader.textContent = "Generated JSON";
        coursesContainer.innerHTML = `<pre style="white-space: pre-wrap; background: #f8f8f8; padding: 1em; border: 1px solid #ddd; max-height: 60vh; overflow-y: auto;">${jsonStr}</pre>`;

        // Trigger download
        const blob = new Blob([jsonStr], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        const filename = stateValue
          ? `${stateValue} Standards Alignment.json`
          : "alignment.json";
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
      });
    </script>
  </body>
</html>
